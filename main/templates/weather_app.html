{% extends "base.html" %}
{% block title %}GlobeWeather{% endblock %}

{% block content %}
<div class="layout">

  <!-- TOP -->
  <div class="topbar">
    <div class="brand">
      <div class="logo"></div>
      <b>Weather</b>
    </div>

    <!-- PREFILL: city query varsa input dolu gÉ™lsin -->
    <input id="q" placeholder="Search city" autocomplete="off" value="{{ city|default:'' }}" />
    <button class="btn" id="go" type="button">Search</button>

    <div class="statuspill" id="status">
      <span class="spin"></span>
      <span id="statusText">Ready</span>
    </div>
  </div>

  <!-- MAP -->
  <section class="map-panel">
    <div id="map" aria-label="Map"></div>
  </section>

  <!-- RIGHT: Next 4 days stacked -->
  <aside class="right">
    <div class="right-title">
      <b>Next 4 days</b>
      <span class="tag" id="rtag">â€”</span>
    </div>

    <div class="citylist" id="daylist">
      <div class="citycard">
        <div class="city-left">
          <div class="ico">â›…</div>
          <div class="city-meta">
            <b>Search a city</b>
            <span>Weâ€™ll show next 4 days here</span>
          </div>
        </div>
        <div class="city-temp">â€”</div>
      </div>
    </div>
  </aside>

  <!-- BOTTOM: Sun â€¢ Time -->
  <section class="bottom">
    <div class="bottom-head">
      <b>Sun â€¢ Time</b>
      <span class="tag" id="updated">â€”</span>
    </div>

    <div
      style="
        border:1px solid rgba(255,255,255,.14);
        background: rgba(255,255,255,.06);
        border-radius: 16px;
        padding: 10px;
        display:flex;
        flex-direction:column;
        gap:8px;
        overflow:hidden;
      "
    >
      <div style="display:flex; justify-content:space-between; gap:10px; align-items:center;">
        <span style="font-size:12px; color:rgba(255,255,255,.62); font-family: ui-monospace,monospace;">Local time</span>
        <b id="localtime" style="font-size:14px; letter-spacing:.2px;">â€”</b>
      </div>

      <div style="display:flex; justify-content:space-between; gap:10px; align-items:center;">
        <span style="font-size:12px; color:rgba(255,255,255,.62); font-family: ui-monospace,monospace;">Sunrise</span>
        <b id="sunrise" style="font-size:14px; letter-spacing:.2px;">â€”</b>
      </div>

      <div style="display:flex; justify-content:space-between; gap:10px; align-items:center;">
        <span style="font-size:12px; color:rgba(255,255,255,.62); font-family: ui-monospace,monospace;">Sunset</span>
        <b id="sunset" style="font-size:14px; letter-spacing:.2px;">â€”</b>
      </div>

      <div style="display:flex; justify-content:space-between; gap:10px; align-items:center;">
        <span style="font-size:12px; color:rgba(255,255,255,.62); font-family: ui-monospace,monospace;">Day length</span>
        <b id="daylen" style="font-size:14px; letter-spacing:.2px;">â€”</b>
      </div>
    </div>
  </section>

</div>

<script
  src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
  crossorigin=""
></script>

<script>
(() => {
  const $ = (id) => document.getElementById(id);

  const statusEl = $("status");
  const statusText = $("statusText");

  function setStatus(text, mode="ready"){
    statusText.textContent = text;
    statusEl.classList.toggle("loading", mode === "loading");
    statusText.classList.toggle("err", mode === "error");
  }

  function nowTime(){
    return new Date().toLocaleTimeString([], {hour:"2-digit", minute:"2-digit"});
  }

  function fmtLocalClockFromOffset(offsetSeconds){
    const nowUtcMs = Date.now();
    const localMs = nowUtcMs + (offsetSeconds * 1000);
    const d = new Date(localMs);
    return d.toLocaleTimeString([], {hour:"2-digit", minute:"2-digit"});
  }

  const map = L.map("map", {
    zoomControl:true,
    preferCanvas:true,
    minZoom: 2
  }).setView([20,10], 2);

  const worldBounds = L.latLngBounds(L.latLng(-85, -180), L.latLng(85, 180));
  map.setMaxBounds(worldBounds);
  map.on("drag", () => map.panInsideBounds(worldBounds, { animate:false }));

  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 19,
    attribution: '&copy; OpenStreetMap'
  }).addTo(map);

  let pinMarker = null;

  function makePinCard(minT, maxT, desc, hum, wind){
    return `
      <div class="pin-card" style="width: 180px; text-align:left; padding:12px 12px 12px;">
        <div style="font-weight:950; font-size:22px; letter-spacing:.2px;">
          ${Math.round(minT)}Â°/${Math.round(maxT)}Â°
        </div>
        <div style="margin-top:6px; font-size:12px; color:rgba(255,255,255,.78);">
          ${desc || "â€”"}
        </div>
        <div style="margin-top:8px; font-size:12px; color:rgba(255,255,255,.78);">
          Hum ${hum ?? "â€”"}%
        </div>
        <div style="margin-top:4px; font-size:12px; color:rgba(255,255,255,.78);">
          Wind ${wind ?? "â€”"} m/s
        </div>
      </div>
    `;
  }

  function setPin(lat, lon, minT, maxT, desc, hum, wind){
    const icon = L.divIcon({
      className: "",
      html: makePinCard(minT, maxT, desc, hum, wind),
      iconSize: [180, 118],
      iconAnchor: [90, 118]
    });

    if (pinMarker) map.removeLayer(pinMarker);
    pinMarker = L.marker([lat, lon], { icon }).addTo(map);
  }

  async function apiSearch(city){
 
    const endpoint = "{% url 'weather_api' %}";
    const res = await fetch(`${endpoint}?city=${encodeURIComponent(city)}`);
    const data = await res.json().catch(() => ({}));
    if(!res.ok){
      const msg = data?.error || "Request failed";
      throw new Error(msg);
    }
    return data;
  }

  function dayLabel(iso){
    const d = new Date(iso + "T00:00:00");
    return d.toLocaleDateString(undefined, { weekday:"short", month:"short", day:"numeric" });
  }

  function iconFor(desc=""){
    const t = (desc || "").toLowerCase();
    if (t.includes("rain")) return "ğŸŒ§ï¸";
    if (t.includes("cloud")) return "â˜ï¸";
    if (t.includes("snow")) return "ğŸŒ¨ï¸";
    if (t.includes("storm") || t.includes("thunder")) return "â›ˆï¸";
    if (t.includes("clear")) return "â˜€ï¸";
    return "â›…";
  }

  function renderNext4Days(daily){
    const list = $("daylist");
    list.innerHTML = "";

    const next = (daily || []).slice(1, 5);

    if (!next.length){
      const el = document.createElement("div");
      el.className = "citycard";
      el.innerHTML = `
        <div class="city-left">
          <div class="ico">â›…</div>
          <div class="city-meta">
            <b>No forecast</b>
            <span>Try another city</span>
          </div>
        </div>
        <div class="city-temp">â€”</div>
      `;
      list.appendChild(el);
      return;
    }

    next.forEach(d => {
      const el = document.createElement("div");
      el.className = "citycard";
      el.innerHTML = `
        <div class="city-left">
          <div class="ico">${iconFor(d.description)}</div>
          <div class="city-meta">
            <b>${dayLabel(d.date)}</b>
            <span>${(d.description || "â€”")} â€¢ Hum ${d.humidity}% â€¢ Wind ${d.wind_speed} m/s</span>
          </div>
        </div>
        <div class="city-temp">${Math.round(d.min)}Â°/${Math.round(d.max)}Â°</div>
      `;
      list.appendChild(el);
    });
  }

  function renderSunPanel(c, sun){
    $("updated").textContent = `Updated ${nowTime()}`;

    const offset = Number(c.timezone || 0);
    $("localtime").textContent = fmtLocalClockFromOffset(offset);

    $("sunrise").textContent = (sun && sun.sunrise) ? sun.sunrise : "â€”";
    $("sunset").textContent  = (sun && sun.sunset)  ? sun.sunset  : "â€”";
    $("daylen").textContent  = (sun && sun.day_length) ? sun.day_length : "â€”";
  }

  async function search(){
    const city = $("q").value.trim();
    if(!city){
      setStatus("Type a city name");
      return;
    }

    try{
      setStatus("Searchingâ€¦", "loading");
      const data = await apiSearch(city);

      const c = data.current;

      setPin(
        c.lat, c.lon,
        c.temp_min, c.temp_max,
        c.description,
        c.humidity,
        c.wind_speed
      );

      map.flyTo([c.lat, c.lon], 6, { animate:true, duration: 1.2 });

      renderNext4Days(data.daily);
      renderSunPanel(c, data.sun || null);

      $("rtag").textContent = `${c.city}, ${c.country}`;
      setStatus("Done");
    }catch(e){
      console.error(e);
      setStatus("Error: " + (e?.message || e), "error");
    }
  }

  $("go").addEventListener("click", () => search());
  $("q").addEventListener("keydown", (e) => {
    if(e.key === "Enter"){
      e.preventDefault();
      search();
    }
  });

  const initial = $("q").value.trim();
  if(initial){
    search();
  }

})();
</script>
{% endblock %}
