{% extends "base.html" %}

{% block title %}Valentine{% endblock %}

{% block extra_head %}
<style>
  /* Base.html d…ôyi≈ümir ‚Äî buna g√∂r…ô tam ekranƒ± FIXED overlay il…ô h…ôll edirik */
  html, body { height: 100%; overflow: hidden !important; }

  :root{
    --bg: #ffffff;
    --black: #000000;
    --yesA: #2af598;
    --yesB: #22c55e;
    --noA:  #ff5f6d;
    --noB:  #ef4444;
    --shadow: 0 18px 60px rgba(0,0,0,.18);
    --shadow2: 0 26px 90px rgba(0,0,0,.26);
  }

  /* === FULLSCREEN ROOT (navbar daxil hamƒ±sƒ±nƒ± √∂rt√ºr) === */
  .v-screen{
    position: fixed;
    inset: 0;
    width: 100vw;
    height: 100vh;
    background: var(--bg);
    z-index: 9999;
    overflow: hidden;
    touch-action: manipulation;
  }

  /* Center wrapper */
  .v-center{
    position: absolute;
    inset: 0;
    display: grid;
    place-items: center;
  }

  /* Buttons row */
  .v-row{
    position: relative;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: clamp(12px, 3vw, 22px);
    width: 100%;
    padding: 22px;
  }

  /* Premium buttons */
  .v-btn{
    appearance: none;
    border: 0;
    cursor: pointer;
    user-select: none;
    -webkit-tap-highlight-color: transparent;

    font-weight: 900;
    letter-spacing: .2px;
    color: #fff;
    line-height: 1;

    padding: clamp(16px, 4.2vw, 22px) clamp(22px, 7vw, 42px);
    font-size: clamp(26px, 8vw, 56px);

    border-radius: 999px;
    box-shadow: var(--shadow);
    transform: translateZ(0) scale(var(--scale, 1));
    transition:
      transform .28s ease,
      filter .28s ease,
      box-shadow .28s ease,
      opacity .28s ease;
    min-width: min(44vw, 320px);
    max-width: 520px;
  }

  .v-btn:hover{ transform: translateZ(0) scale(calc(var(--scale, 1) * 1.02)); box-shadow: var(--shadow2); }
  .v-btn:active{ transform: translateZ(0) scale(calc(var(--scale, 1) * .985)); }

  .v-yes{
    background: radial-gradient(120% 120% at 20% 10%, rgba(255,255,255,.35), transparent 55%),
                linear-gradient(135deg, var(--yesA), var(--yesB));
    filter: saturate(1.05);
  }
  .v-no{
    background: radial-gradient(120% 120% at 20% 10%, rgba(255,255,255,.30), transparent 55%),
                linear-gradient(135deg, var(--noA), var(--noB));
    filter: saturate(1.05);
  }

  /* "Nie" teleport √º√ß√ºn absolute */
  .no-abs{
    position: absolute !important;
    left: 50%;
    top: 50%;
    transform: translate(-50%, -50%) scale(var(--noScale, 1));
    z-index: 3; /* Tak il…ô √ºst-√ºst…ô d√º≈üm…ôsin dey…ô Tak-ƒ± daha yuxarƒ± z-index edirik */
    margin: 0;
    min-width: min(40vw, 300px);
  }

  /* Tak h…ômi≈ü…ô √∂n planda */
  #yesBtn{ position: relative; z-index: 5; }

  /* Tak / Nie scale (JS set) */
  #yesBtn{ --scale: var(--yesScale, 1); }
  #noBtn { --scale: var(--noScale, 1); }

  /* Fade helpers */
  .fade-out{ opacity: 0; transform: scale(.98); pointer-events: none; transition: opacity 1.1s ease, transform 1.1s ease; }
  .fade-in { opacity: 1; transform: scale(1); }

  /* Overlays cover ENTIRE viewport */
  .ov{
    position: fixed;
    inset: 0;
    background: var(--black);
    opacity: 0;
    pointer-events: none;
    transition: opacity 1.4s ease;
    z-index: 20;
  }
  .ov.show{ opacity: 1; }

  /* Message in center */
  .msg{
    position: fixed;
    inset: 0;
    display: grid;
    place-items: center;
    text-align: center;
    padding: 26px;
    opacity: 0;
    transform: translateY(10px);
    transition: opacity 1.0s ease, transform 1.0s ease;
    z-index: 30;
    pointer-events: none;

    color: #fff;
    font-weight: 900;
    letter-spacing: -0.02em;
    font-size: clamp(16px, 4.8vw, 40px);
    line-height: 1.25;
  }
  .msg.show{ opacity: 1; transform: translateY(0); }

  /* Canvas layers */
  canvas.fx{
    position: fixed;
    inset: 0;
    width: 100vw;
    height: 100vh;
    display: block;
    pointer-events: none;
    z-index: 25;
    opacity: 0;
    transition: opacity 1.0s ease;
  }
  canvas.fx.show{ opacity: 1; }

  /* Heart scene */
  .heartScene{
    position: fixed;
    inset: 0;
    display: grid;
    place-items: center;
    opacity: 0;
    transition: opacity 1.0s ease;
    z-index: 40;
    pointer-events: none;
    background: #000; /* ‚Äútam qara ekran‚Äù */
  }
  .heartScene.show{ opacity: 1; }

  .heart{
    width: min(240px, 60vw);
    aspect-ratio: 1/1;
    animation: beat .95s ease-in-out infinite;
    filter: drop-shadow(0 18px 55px rgba(255, 0, 90, .25));
  }
  @keyframes beat{
    0%,100%{ transform: scale(1); }
    35%{ transform: scale(1.14); }
    55%{ transform: scale(.98); }
  }

  /* === NO effects === */
  .shake3s{ animation: shake .12s ease-in-out infinite; }
  @keyframes shake{
    0%  { transform: translate(-50%,-50%) scale(var(--noScale, 1)) translateX(-2px); }
    50% { transform: translate(-50%,-50%) scale(var(--noScale, 1)) translateX( 2px); }
    100%{ transform: translate(-50%,-50%) scale(var(--noScale, 1)) translateX(-2px); }
  }

  /* Split + rejoin 5s */
  .break5s{ animation: splitJoin 5s ease-in-out forwards; }
  @keyframes splitJoin{
    0%   { clip-path: inset(0 0 0 0); }
    18%  { clip-path: inset(0 50% 0 0); transform: translate(-50%,-50%) scale(var(--noScale, 1)) translateX(-16px) rotate(-2deg); }
    36%  { clip-path: inset(0 0 0 50%); transform: translate(-50%,-50%) scale(var(--noScale, 1)) translateX( 16px) rotate( 2deg); }
    62%  { clip-path: inset(0 0 0 0); transform: translate(-50%,-50%) scale(var(--noScale, 1)) translateX(0) rotate(0deg); }
    100% { clip-path: inset(0 0 0 0); transform: translate(-50%,-50%) scale(var(--noScale, 1)); }
  }

  /* Stage 9: qara ekran + yalnƒ±z super b√∂y√ºk Tak */
  .stage9{
    background: #000 !important;
  }
  .stage9 #yesBtn{
    position: fixed !important;
    left: 50% !important;
    top: 50% !important;
    transform: translate(-50%, -50%) scale(var(--yesScale, 1)) !important;
    min-width: min(82vw, 760px) !important;
    z-index: 60 !important;
    box-shadow: 0 30px 110px rgba(0,0,0,.75);
  }
  .stage9 #noBtn{
    display: none !important; /* …ôn vacibi: Nie tam yox olur */
  }

</style>
{% endblock %}

{% block content %}
<div class="v-screen" id="root">
  <div class="v-center" id="center">
    <div class="v-row" id="row">
      <button class="v-btn v-yes" id="yesBtn" type="button">Tak</button>
      <button class="v-btn v-no" id="noBtn" type="button">Nie</button>
    </div>
  </div>

  <!-- YES flow -->
  <div class="ov" id="dark1"></div>
  <canvas class="fx" id="stars"></canvas>

  <div class="msg" id="msg"></div>

  <div class="heartScene" id="heartScene">
    <svg class="heart" viewBox="0 0 64 64" aria-hidden="true">
      <path fill="#ff2d55" d="M47.5,6.5c-5.4,0-9.3,3.1-11.5,6.2C33.8,9.6,29.9,6.5,24.5,6.5
      C16.9,6.5,11,12.7,11,20.3c0,12.3,21,28.8,21,28.8s21-16.5,21-28.8C53,12.7,47.1,6.5,47.5,6.5z"/>
    </svg>
  </div>

  <!-- Stage 9: broken hearts rain -->
  <canvas class="fx" id="broken"></canvas>
</div>

<script>
/*
  Kod: Az…ôrbaycan dilind…ô.
  UI: yalnƒ±z "Tak", "Nie", v…ô mesaj.
*/
(function(){
  const root = document.getElementById("root");
  const row = document.getElementById("row");
  const yesBtn = document.getElementById("yesBtn");
  const noBtn = document.getElementById("noBtn");

  const dark1 = document.getElementById("dark1");
  const stars = document.getElementById("stars");
  const broken = document.getElementById("broken");
  const msg = document.getElementById("msg");
  const heartScene = document.getElementById("heartScene");

  const sctx = stars.getContext("2d");
  const bctx = broken.getContext("2d");

  // Mesaj (polyakca). ƒ∞st…ôs…ôn √∂z c√ºml…ônl…ô d…ôyi≈ü.
  const MESAJ = "Awwwww. Oficjalnie jeste≈õ walentynkƒÖ Elvina ‚Äî kochana Ola hehe";

  let noKlik = 0;
  let yesScale = 1;
  let noScale = 1;

  let yesFlowAktiv = false;
  let stage9Aktiv = false;

  // ===== Canvas √∂l√ß√ºl…ôri =====
  function canvasOlcu(){
    const dpr = Math.max(1, window.devicePixelRatio || 1);
    const w = window.innerWidth;
    const h = window.innerHeight;

    [stars, broken].forEach(c => {
      c.width = Math.floor(w * dpr);
      c.height = Math.floor(h * dpr);
      c.style.width = w + "px";
      c.style.height = h + "px";
    });

    sctx.setTransform(dpr,0,0,dpr,0,0);
    bctx.setTransform(dpr,0,0,dpr,0,0);
  }
  window.addEventListener("resize", canvasOlcu, { passive:true });
  canvasOlcu();

  // ===== CSS scale set =====
  function skalaQur(){
    root.style.setProperty("--yesScale", String(yesScale));
    root.style.setProperty("--noScale", String(noScale));
  }
  skalaQur();

  // ===== Nie absolute rejim =====
  function noAbsoluteEt(){
    if(!noBtn.classList.contains("no-abs")){
      noBtn.classList.add("no-abs");
      root.appendChild(noBtn); // row-dan √ßƒ±xƒ±b tam ekranda s…ôrb…ôst olur
    }
  }

  function noAnimTemizle(){
    noBtn.classList.remove("shake3s");
    noBtn.classList.remove("break5s");
  }

  // Tak d√ºym…ôsinin m…ôrk…ôz zonasƒ± (Nie ora d√º≈üm…ôsin)
  function m…ôrk…ôzQadaƒüaYoxla(x, y){
    const cx = window.innerWidth / 2;
    const cy = window.innerHeight / 2;
    const qx = Math.abs(x - cx);
    const qy = Math.abs(y - cy);
    // m…ôrk…ôz …ôtrafƒ±nda ‚Äúqadaƒüa‚Äù zonasƒ± (Tak-ƒ±n √ºst√ºn…ô d√º≈üm…ôsin)
    return (qx < 190 && qy < 140);
  }

  function noYerQur(px, py){
    noAbsoluteEt();
    noBtn.style.left = px + "px";
    noBtn.style.top  = py + "px";
  }

  function randomNoYer(){
    // viewport daxilind…ô random yer, amma m…ôrk…ôz qadaƒüa zonasƒ± yoxlanƒ±r
    const pad = 22;
    const bw = noBtn.getBoundingClientRect().width || 240;
    const bh = noBtn.getBoundingClientRect().height || 80;

    const maxX = window.innerWidth - bw - pad;
    const maxY = window.innerHeight - bh - pad;

    let x, y, guard = 0;
    do {
      x = pad + Math.random() * Math.max(pad, maxX - pad);
      y = pad + Math.random() * Math.max(pad, maxY - pad);
      guard++;
      if(guard > 40) break;
    } while(m…ôrk…ôzQadaƒüaYoxla(x, y));

    noYerQur(x, y);
  }

  // ===== Stage 9 broken hearts rain =====
  let brokenArr = [];
  let brokenRAF = null;

  function brokenHazirla(){
    brokenArr = [];
    const w = window.innerWidth, h = window.innerHeight;
    const say = Math.max(80, Math.floor((w*h) / 16000));
    for(let i=0;i<say;i++){
      brokenArr.push({
        x: Math.random()*w,
        y: Math.random()*h,
        sp: 3 + Math.random()*6,
        sz: 18 + Math.random()*18,
        rot: Math.random()*Math.PI*2,
        vr: (-0.03 + Math.random()*0.06),
        a: 0.65 + Math.random()*0.35,
      });
    }
  }

  function brokenCek(){
    const w = window.innerWidth, h = window.innerHeight;
    bctx.clearRect(0,0,w,h);

    for(const p of brokenArr){
      p.y += p.sp;
      p.rot += p.vr;
      if(p.y > h + 40){
        p.y = -40;
        p.x = Math.random()*w;
      }
      bctx.save();
      bctx.translate(p.x, p.y);
      bctx.rotate(p.rot);
      bctx.globalAlpha = p.a;
      bctx.font = `${p.sz}px system-ui, Apple Color Emoji, Segoe UI Emoji, Noto Color Emoji`;
      bctx.textAlign = "center";
      bctx.textBaseline = "middle";
      bctx.fillText("üíî", 0, 0);
      bctx.restore();
    }
    brokenRAF = requestAnimationFrame(brokenCek);
  }

  function brokenStart(){
    broken.classList.add("show");
    brokenHazirla();
    if(brokenRAF) cancelAnimationFrame(brokenRAF);
    brokenRAF = requestAnimationFrame(brokenCek);
  }

  function brokenStop(){
    broken.classList.remove("show");
    if(brokenRAF) cancelAnimationFrame(brokenRAF);
    brokenRAF = null;
    bctx.clearRect(0,0,window.innerWidth, window.innerHeight);
  }

  // ===== Stars rain (YES flow) =====
  let starsArr = [];
  let starsRAF = null;

  function starsHazirla(){
    starsArr = [];
    const w = window.innerWidth, h = window.innerHeight;
    const say = Math.max(70, Math.floor((w*h)/22000));
    for(let i=0;i<say;i++){
      starsArr.push({
        x: Math.random()*w,
        y: Math.random()*h,
        sp: 2 + Math.random()*5,
        sz: 1 + Math.random()*2.3,
        a: 0.45 + Math.random()*0.55
      });
    }
  }

  function starsCek(){
    const w = window.innerWidth, h = window.innerHeight;
    sctx.clearRect(0,0,w,h);

    for(const p of starsArr){
      p.y += p.sp;
      if(p.y > h + 10){
        p.y = -10;
        p.x = Math.random()*w;
      }
      sctx.globalAlpha = p.a;
      sctx.fillStyle = "#fff";
      sctx.beginPath();
      sctx.arc(p.x, p.y, p.sz, 0, Math.PI*2);
      sctx.fill();
    }
    starsRAF = requestAnimationFrame(starsCek);
  }

  function starsStart(){
    stars.classList.add("show");
    starsHazirla();
    if(starsRAF) cancelAnimationFrame(starsRAF);
    starsRAF = requestAnimationFrame(starsCek);
  }

  function starsStop(){
    stars.classList.remove("show");
    if(starsRAF) cancelAnimationFrame(starsRAF);
    starsRAF = null;
    sctx.clearRect(0,0,window.innerWidth, window.innerHeight);
  }

  // ===== Reset =====
  function resetBaslangic(){
    yesFlowAktiv = false;
    stage9Aktiv = false;

    root.classList.remove("stage9");

    // overlay & scenes off
    dark1.classList.remove("show");
    msg.classList.remove("show");
    heartScene.classList.remove("show");
    msg.textContent = "";

    // canvases off
    starsStop();
    brokenStop();

    // buttons back
    row.classList.remove("fade-out");
    yesBtn.disabled = false;
    noBtn.disabled = false;

    // scales reset
    noKlik = 0;
    yesScale = 1;
    noScale = 1;
    skalaQur();

    // Nie button back into row
    if(noBtn.classList.contains("no-abs")){
      noAnimTemizle();
      noBtn.classList.remove("no-abs");
      noBtn.style.left = "";
      noBtn.style.top = "";
      row.appendChild(noBtn);
    }
  }

  // ===== Stage 9 start =====
  function stage9Basla(){
    stage9Aktiv = true;

    // everything else off
    dark1.classList.remove("show");
    msg.classList.remove("show");
    heartScene.classList.remove("show");
    msg.textContent = "";
    starsStop();

    // make screen black and hide Nie via CSS (.stage9 #noBtn display:none)
    root.classList.add("stage9");
    noBtn.disabled = true;

    brokenStart();
  }

  // ===== YES flow =====
  function yesFlowBasla(){
    yesFlowAktiv = true;

    // Stage9 varsa dayandƒ±r
    if(stage9Aktiv){
      brokenStop();
      stage9Aktiv = false;
      root.classList.remove("stage9");
    }

    // buttons fade out
    row.classList.add("fade-out");
    yesBtn.disabled = true;
    noBtn.disabled = true;

    // full dark
    dark1.classList.add("show");

    // stars + message
    msg.textContent = MESAJ;
    starsStart();
    msg.classList.add("show");

    // 5s sonra: tam qara + heart (10s)
    setTimeout(() => {
      msg.classList.remove("show");
      msg.textContent = "";
      heartScene.classList.add("show");
    }, 5000);

    // 15s sonra reset
    setTimeout(() => {
      resetBaslangic();
    }, 15000);
  }

  // ===== Click handlers =====
  yesBtn.addEventListener("click", () => {
    if(yesFlowAktiv) return;
    yesFlowBasla();
  });

  noBtn.addEventListener("click", () => {
    if(yesFlowAktiv) return;

    noKlik += 1;

    // h…ôr klikd…ô random yer…ô getsin (amma m…ôrk…ôzd…ôn qa√ßsƒ±n)
    if(![3,4,6,9].includes(noKlik)){
      randomNoYer();
    } else {
      noAbsoluteEt();
    }

    // 1: 3s shake
    if(noKlik === 1){
      noAnimTemizle();
      noBtn.classList.add("shake3s");
      setTimeout(()=> noBtn.classList.remove("shake3s"), 3000);
      return;
    }

    // 2: break 5s
    if(noKlik === 2){
      noAnimTemizle();
      noBtn.classList.add("break5s");
      setTimeout(()=> noBtn.classList.remove("break5s"), 5000);
      return;
    }

    // 3: sol √ºst
    if(noKlik === 3){
      noYerQur(30, 30);
      return;
    }

    // 4: saƒü alt
    if(noKlik === 4){
      const bw = noBtn.getBoundingClientRect().width || 240;
      const bh = noBtn.getBoundingClientRect().height || 80;
      noYerQur(window.innerWidth - bw - 30, window.innerHeight - bh - 30);
      return;
    }

    // 6: orta yuxarƒ±
    if(noKlik === 6){
      const bw = noBtn.getBoundingClientRect().width || 240;
      noYerQur((window.innerWidth - bw)/2, 30);
      return;
    }

    // 7: No 2x ki√ßik, Yes 2x b√∂y√ºk
    if(noKlik === 7){
      noScale *= 0.5;
      yesScale *= 2;
      skalaQur();
      randomNoYer();
      return;
    }

    // 8: yen…ô
    if(noKlik === 8){
      noScale *= 0.5;
      yesScale *= 2;
      skalaQur();
      randomNoYer();
      return;
    }

    // 9: stage 9
    if(noKlik === 9){
      stage9Basla();
      return;
    }
  });

})();
</script>
{% endblock %}
