{% extends "base.html" %}

{% block title %}Valentine{% endblock %}

{% block extra_head %}
<style>
  :root{
    --bg: #ffffff;
    --text: #0b1020;
    --yes: #22c55e;
    --no: #ef4444;
  }

  /* Fullscreen, no frames */
  .v-full {
    position: relative;
    width: 100%;
    min-height: calc(100vh - 0px);
    overflow: hidden;
    background: var(--bg);
  }

  /* Center layout */
  .v-center {
    position: absolute;
    inset: 0;
    display: grid;
    place-items: center;
  }

  .v-buttons {
    display: flex;
    gap: 18px;
    align-items: center;
    justify-content: center;
    padding: 20px;
    width: 100%;
  }

  /* Big buttons, mobile-first */
  .v-btn {
    appearance: none;
    border: 0;
    border-radius: 22px;
    padding: 18px 26px;
    font-weight: 900;
    letter-spacing: 0.5px;
    font-size: clamp(22px, 7vw, 44px);
    line-height: 1;
    color: #fff;
    box-shadow: 0 18px 45px rgba(0,0,0,.18);
    transform: translateZ(0) scale(1);
    transition: transform .35s ease, filter .35s ease, opacity .35s ease;
    user-select: none;
    touch-action: manipulation;
    min-width: min(44vw, 260px);
    max-width: 420px;
  }

  .v-btn:active { transform: translateZ(0) scale(.98); }

  .v-yes { background: linear-gradient(135deg, rgba(34,197,94,1), rgba(16,185,129,1)); }
  .v-no  { background: linear-gradient(135deg, rgba(239,68,68,1), rgba(244,63,94,1)); }

  /* No button will be absolutely positioned after some stages */
  .v-no.abs {
    position: absolute;
    left: 50%;
    top: 50%;
    transform: translate(-50%, -50%) scale(var(--noScale, 1));
    margin: 0;
    min-width: min(40vw, 240px);
  }

  /* Yes scaling via CSS variable */
  .v-yes { transform: translateZ(0) scale(var(--yesScale, 1)); }
  .v-yes:active { transform: translateZ(0) scale(calc(var(--yesScale, 1) * .98)); }

  /* Overlays */
  .overlay {
    position: absolute;
    inset: 0;
    pointer-events: none;
    opacity: 0;
    transition: opacity 1.3s ease;
  }

  .overlay.dark {
    background: #000;
  }

  .overlay.show {
    opacity: 1;
  }

  /* Center message */
  .msg {
    position: absolute;
    inset: 0;
    display: grid;
    place-items: center;
    text-align: center;
    padding: 26px;
    pointer-events: none;
    opacity: 0;
    transform: translateY(10px);
    transition: opacity 1s ease, transform 1s ease;
    color: #fff;
    font-weight: 900;
    letter-spacing: -0.02em;
    font-size: clamp(16px, 4.8vw, 36px);
    line-height: 1.25;
  }
  .msg.show {
    opacity: 1;
    transform: translateY(0);
  }

  /* Heart scene */
  .heart-scene {
    position: absolute;
    inset: 0;
    display: grid;
    place-items: center;
    pointer-events: none;
    opacity: 0;
    transition: opacity 1s ease;
  }
  .heart-scene.show { opacity: 1; }

  .heart {
    width: min(220px, 55vw);
    aspect-ratio: 1/1;
    filter: drop-shadow(0 16px 40px rgba(255,0,80,.18));
    animation: beat 0.95s ease-in-out infinite;
  }
  @keyframes beat {
    0%,100%{ transform: scale(1); }
    35%{ transform: scale(1.13); }
    55%{ transform: scale(0.98); }
  }

  /* Rain canvases */
  canvas.rain {
    position: absolute;
    inset: 0;
    width: 100%;
    height: 100%;
    display: block;
    pointer-events: none;
  }

  /* No: shake 3s */
  .shake3s {
    animation: shake .12s ease-in-out infinite;
  }
  @keyframes shake {
    0%{ transform: translate(-50%, -50%) scale(var(--noScale, 1)) translateX(-2px); }
    50%{ transform: translate(-50%, -50%) scale(var(--noScale, 1)) translateX(2px); }
    100%{ transform: translate(-50%, -50%) scale(var(--noScale, 1)) translateX(-2px); }
  }

  /* No: break + rejoin (5s) */
  .break5s {
    animation: breakAnim 5s ease-in-out forwards;
  }
  @keyframes breakAnim {
    0%   { clip-path: inset(0 0 0 0); filter: none; }
    12%  { clip-path: inset(0 50% 0 0); transform: translate(-50%,-50%) scale(var(--noScale, 1)) translateX(-14px) rotate(-2deg); }
    24%  { clip-path: inset(0 0 0 50%); transform: translate(-50%,-50%) scale(var(--noScale, 1)) translateX(14px) rotate(2deg); }
    40%  { clip-path: inset(0 50% 0 0); transform: translate(-50%,-50%) scale(var(--noScale, 1)) translateX(-18px) rotate(-3deg); }
    62%  { clip-path: inset(0 0 0 0); transform: translate(-50%,-50%) scale(var(--noScale, 1)) translateX(0) rotate(0deg); }
    100% { clip-path: inset(0 0 0 0); transform: translate(-50%,-50%) scale(var(--noScale, 1)); }
  }

  /* Soft fade helpers */
  .fade-out {
    opacity: 0;
    transition: opacity 1.1s ease;
  }
  .fade-in {
    opacity: 1;
    transition: opacity 1.1s ease;
  }

  /* Stage 9: only huge yes on black */
  .stage9 {
    background: #000 !important;
  }
  .stage9 .v-no { opacity: 0 !important; pointer-events: none !important; }
  .stage9 .v-yes {
    position: absolute;
    left: 50%;
    top: 50%;
    transform: translate(-50%,-50%) scale(var(--yesScale, 1)) !important;
    min-width: min(78vw, 520px);
    border-radius: 28px;
    box-shadow: 0 26px 70px rgba(0,0,0,.65);
    z-index: 5;
  }

  /* Ensure no scrollbars on mobile */
  body { overflow-x: hidden; }
</style>
{% endblock %}

{% block content %}
<div class="v-full" id="root">
  <div class="v-center" id="center">
    <div class="v-buttons" id="btnRow">
      <button class="v-btn v-yes" id="yesBtn" type="button">Tak</button>
      <button class="v-btn v-no" id="noBtn" type="button">Nie</button>
    </div>
  </div>

  <!-- Dark overlay + star rain (Yes flow) -->
  <div class="overlay dark" id="dark1"></div>
  <canvas class="rain" id="starsCanvas"></canvas>
  <div class="msg" id="msg">
    Awwwww. Siz r…ôsmi olaraq Elvin in valentinesiziniz Sevgili Ola hehe
  </div>

  <!-- Heart scene (after 5s) -->
  <div class="overlay dark" id="dark2"></div>
  <div class="heart-scene" id="heartScene">
    <svg class="heart" viewBox="0 0 64 64" aria-hidden="true">
      <path fill="#ff2d55" d="M47.5,6.5c-5.4,0-9.3,3.1-11.5,6.2C33.8,9.6,29.9,6.5,24.5,6.5
      C16.9,6.5,11,12.7,11,20.3c0,12.3,21,28.8,21,28.8s21-16.5,21-28.8C53,12.7,47.1,6.5,47.5,6.5z"/>
    </svg>
  </div>

  <!-- Broken hearts rain (Stage 9) -->
  <canvas class="rain" id="brokenCanvas"></canvas>
</div>

<script>
/*
  Kod dili Az…ôrbaycan dilind…ô (d…ôyi≈ü…ôn adlarƒ± v…ô ≈ü…ôrhl…ôr).
  UI m…ôtni polyak√ßa: Tak / Nie, v…ô final mesaj.
*/

(function(){
  const root = document.getElementById("root");
  const yesBtn = document.getElementById("yesBtn");
  const noBtn = document.getElementById("noBtn");
  const btnRow = document.getElementById("btnRow");

  const dark1 = document.getElementById("dark1");
  const dark2 = document.getElementById("dark2");
  const msg = document.getElementById("msg");
  const heartScene = document.getElementById("heartScene");

  const starsCanvas = document.getElementById("starsCanvas");
  const brokenCanvas = document.getElementById("brokenCanvas");
  const sctx = starsCanvas.getContext("2d");
  const bctx = brokenCanvas.getContext("2d");

  let noKlik = 0;
  let yesScale = 1;
  let noScale = 1;

  let valentineAkti = false;
  let stage9Akti = false;

  // ====== √ñl√ß√ºl…ôr ======
  function canvasOlcu(){
    const dpr = Math.max(1, window.devicePixelRatio || 1);

    const r = root.getBoundingClientRect();

    [starsCanvas, brokenCanvas].forEach(c => {
      c.width = Math.floor(r.width * dpr);
      c.height = Math.floor(r.height * dpr);
      c.style.width = r.width + "px";
      c.style.height = r.height + "px";
    });

    sctx.setTransform(dpr,0,0,dpr,0,0);
    bctx.setTransform(dpr,0,0,dpr,0,0);
  }
  window.addEventListener("resize", canvasOlcu, { passive: true });
  canvasOlcu();

  // ====== No d√ºym…ôsini absolute edib ist…ôn…ôn yer…ô qoymaq ======
  function noAbsoluteEt(){
    if(!noBtn.classList.contains("abs")){
      noBtn.classList.add("abs");
      // btnRow i√ßind…ôn √ßƒ±xarƒ±b root-a ataq ki s…ôrb…ôst h…ôr…ôk…ôt etsin
      root.appendChild(noBtn);
    }
  }

  function noYerQur(xPerc, yPerc){
    // xPerc,yPerc: 0..100
    noAbsoluteEt();
    noBtn.style.left = xPerc + "%";
    noBtn.style.top  = yPerc + "%";
  }

  function skalaQur(){
    root.style.setProperty("--yesScale", String(yesScale));
    root.style.setProperty("--noScale", String(noScale));
  }
  skalaQur();

  // ====== Anim sinifl…ôrini t…ômizl…ô ======
  function noAnimTemizle(){
    noBtn.classList.remove("shake3s");
    noBtn.classList.remove("break5s");
  }

  // ====== No click m…ôrh…ôl…ôl…ôri ======
  noBtn.addEventListener("click", () => {
    if(valentineAkti) return;

    noKlik += 1;

    // h…ôr klikd…ô f…ôrqli yer…ô ‚Äúke√ßsin‚Äù (t…ôl…ôbin √ºmumi hiss…ôsi)
    // amma x√ºsusi m…ôrh…ôl…ôl…ôrd…ô konkret yer ist…ôyirs…ôn ‚Äî onlarƒ± a≈üaƒüƒ±da override edirik.
    const randomX = 20 + Math.random() * 60;
    const randomY = 25 + Math.random() * 55;

    // x√ºsusi m…ôrh…ôl…ôl…ôrd…ôn …ôvv…ôl √ºmumi random teleport
    if(![3,4,6].includes(noKlik)){
      noYerQur(randomX, randomY);
    }

    // No-1: 3 saniy…ô titr…ôsin
    if(noKlik === 1){
      noAbsoluteEt();
      noAnimTemizle();
      noBtn.classList.add("shake3s");
      setTimeout(()=> noBtn.classList.remove("shake3s"), 3000);
      return;
    }

    // No-2: ortadan qƒ±rƒ±lsƒ±n-birl…ô≈üsin 5 saniy…ô
    if(noKlik === 2){
      noAbsoluteEt();
      noAnimTemizle();
      noBtn.classList.add("break5s");
      setTimeout(()=> noBtn.classList.remove("break5s"), 5000);
      return;
    }

    // No-3: sol √ºst
    if(noKlik === 3){
      noYerQur(16, 18);
      return;
    }

    // No-4: saƒü alt
    if(noKlik === 4){
      noYerQur(84, 84);
      return;
    }

    // No-6: orta yuxarƒ±
    if(noKlik === 6){
      noYerQur(50, 18);
      return;
    }

    // No-7: No 2x ki√ßik, Yes 2x b√∂y√ºk
    if(noKlik === 7){
      noScale *= 0.5;
      yesScale *= 2;
      skalaQur();
      return;
    }

    // No-8: yen…ô No 2x ki√ßik, Yes yen…ô 2x b√∂y√ºk
    if(noKlik === 8){
      noScale *= 0.5;
      yesScale *= 2;
      skalaQur();
      return;
    }

    // No-9: ekran qapqara + yalnƒ±z b√∂y√ºk Yes + qƒ±rƒ±q √ºr…ôk yaƒüƒ±≈üƒ± (Yes basƒ±lana q…ôd…ôr)
    if(noKlik === 9){
      stage9Basla();
      return;
    }
  });

  // ====== Yes click ======
  yesBtn.addEventListener("click", () => {
    if(stage9Akti){
      // Stage 9-da basƒ±lƒ±nca normal ‚ÄúYes‚Äù flow ba≈ülasƒ±n (qaralma+ulduz+mesaj+√ºr…ôk+geri)
      stopBrokenRain();
      stage9Akti = false;
      root.classList.remove("stage9");
      // No-nu geri g…ôtirmirik; onsuz artƒ±q t…ôl…ôb…ô uyƒüun Yes qalƒ±r.
    }
    if(valentineAkti) return;
    yesAxiBasla();
  });

  // =======================
  // YES FLOW: aƒü -> qara -> ulduz yaƒüƒ±≈üƒ± + mesaj (5s) -> tam qara + d√∂y√ºn…ôn √ºr…ôk (10s) -> ba≈ülanƒüƒ±c
  // =======================
  let stars = [];
  let starsRAF = null;

  function ulduzlarHazirla(){
    stars = [];
    const r = root.getBoundingClientRect();
    const say = Math.max(60, Math.floor(r.width * r.height / 22000)); // adaptiv
    for(let i=0;i<say;i++){
      stars.push({
        x: Math.random() * r.width,
        y: Math.random() * r.height,
        sp: 2 + Math.random() * 5,
        sz: 1 + Math.random() * 2.2,
        a: 0.45 + Math.random() * 0.55,
      });
    }
  }

  function ulduzCek(){
    const r = root.getBoundingClientRect();
    sctx.clearRect(0,0,r.width,r.height);

    // qara fonda ulduzlar
    for(const p of stars){
      p.y += p.sp;
      if(p.y > r.height + 10){
        p.y = -10;
        p.x = Math.random() * r.width;
      }
      sctx.globalAlpha = p.a;
      sctx.fillStyle = "#ffffff";
      sctx.beginPath();
      sctx.arc(p.x, p.y, p.sz, 0, Math.PI*2);
      sctx.fill();
    }

    starsRAF = requestAnimationFrame(ulduzCek);
  }

  function ulduzStart(){
    ulduzlarHazirla();
    if(starsRAF) cancelAnimationFrame(starsRAF);
    starsRAF = requestAnimationFrame(ulduzCek);
  }

  function ulduzStop(){
    if(starsRAF) cancelAnimationFrame(starsRAF);
    starsRAF = null;
    const r = root.getBoundingClientRect();
    sctx.clearRect(0,0,r.width,r.height);
  }

  function yesAxiBasla(){
    valentineAkti = true;

    // ba≈ülanƒüƒ±c d√ºym…ôl…ôri yum≈üaq s√∂ns√ºn
    btnRow.classList.add("fade-out");

    // ekran yava≈ü qaralsƒ±n
    dark1.classList.add("show");

    // ulduz yaƒüƒ±≈üƒ± + mesaj
    ulduzStart();
    msg.classList.add("show");

    // 5 saniy…ô sonra: tam qara ekran + √ºr…ôk (10 saniy…ô)
    setTimeout(() => {
      msg.classList.remove("show");
      dark2.classList.add("show");
      heartScene.classList.add("show");
    }, 5000);

    // 15 saniy…ô sonra: ba≈ülanƒüƒ±ca qayƒ±t
    setTimeout(() => {
      sifirlaBaslangic();
    }, 15000);
  }

  function sifirlaBaslangic(){
    // h…ôr ≈üeyi yum≈üaq sƒ±fƒ±rla
    valentineAkti = false;

    // ulduzlarƒ± dayandƒ±r
    ulduzStop();

    // overlay-l…ôr yava≈ü s√∂ns√ºn
    dark1.classList.remove("show");
    dark2.classList.remove("show");

    // √ºr…ôyi gizl…ôt
    heartScene.classList.remove("show");

    // mesaj gizli qalsƒ±n
    msg.classList.remove("show");

    // stage9 varsa s√∂nd√ºr
    stopBrokenRain();
    stage9Akti = false;
    root.classList.remove("stage9");

    // d√ºym…ôl…ôri geri g…ôtir
    btnRow.classList.remove("fade-out");

    // No click state reset (ist…ôdin dey…ô: ba≈ülanƒüƒ±c ekrana tam qayƒ±tsƒ±n)
    noKlik = 0;
    yesScale = 1;
    noScale = 1;
    skalaQur();

    // No d√ºym…ôsini yenid…ôn row-a qaytar
    if(noBtn.classList.contains("abs")){
      noBtn.classList.remove("abs");
      noBtn.style.left = "";
      noBtn.style.top = "";
      noBtn.style.transform = "";
      noAnimTemizle();
      // root-dan √ßƒ±xarƒ±b yenid…ôn row-a ataq
      btnRow.appendChild(noBtn);
    }

    // Yes d√ºym…ôsinin m√∂vqeyi normal olsun
    yesBtn.disabled = false;
    noBtn.disabled = false;

    // fon aƒü qalsƒ±n
    root.style.background = "#ffffff";

    // broken canvas t…ômiz
    const r = root.getBoundingClientRect();
    bctx.clearRect(0,0,r.width,r.height);
  }

  // =======================
  // STAGE 9: qara ekran + yalnƒ±z b√∂y√ºk Yes + qƒ±rƒ±q √ºr…ôk yaƒüƒ±≈üƒ± (Yes basƒ±lana q…ôd…ôr)
  // =======================
  let broken = [];
  let brokenRAF = null;

  function brokenHazirla(){
    broken = [];
    const r = root.getBoundingClientRect();
    const say = Math.max(70, Math.floor(r.width * r.height / 18000));
    for(let i=0;i<say;i++){
      broken.push({
        x: Math.random() * r.width,
        y: Math.random() * r.height,
        sp: 3 + Math.random() * 6.5,
        sz: 18 + Math.random() * 16,
        rot: Math.random() * Math.PI*2,
        vr: (-0.03 + Math.random()*0.06),
        a: 0.65 + Math.random()*0.35,
      });
    }
  }

  function brokenCek(){
    const r = root.getBoundingClientRect();
    bctx.clearRect(0,0,r.width,r.height);

    for(const p of broken){
      p.y += p.sp;
      p.rot += p.vr;
      if(p.y > r.height + 40){
        p.y = -40;
        p.x = Math.random() * r.width;
      }

      bctx.save();
      bctx.translate(p.x, p.y);
      bctx.rotate(p.rot);
      bctx.globalAlpha = p.a;
      // emoji draw
      bctx.font = `${p.sz}px system-ui, Apple Color Emoji, Segoe UI Emoji, Noto Color Emoji`;
      bctx.textAlign = "center";
      bctx.textBaseline = "middle";
      bctx.fillText("üíî", 0, 0);
      bctx.restore();
    }

    brokenRAF = requestAnimationFrame(brokenCek);
  }

  function startBrokenRain(){
    brokenHazirla();
    if(brokenRAF) cancelAnimationFrame(brokenRAF);
    brokenRAF = requestAnimationFrame(brokenCek);
  }

  function stopBrokenRain(){
    if(brokenRAF) cancelAnimationFrame(brokenRAF);
    brokenRAF = null;
    const r = root.getBoundingClientRect();
    bctx.clearRect(0,0,r.width,r.height);
  }

  function stage9Basla(){
    stage9Akti = true;

    // qara ekran + yalnƒ±z yes
    root.classList.add("stage9");

    // ulduz v…ô dig…ôr overlay-l…ôri s√∂nd√ºr (ani yox, soft)
    dark1.classList.remove("show");
    dark2.classList.remove("show");
    msg.classList.remove("show");
    heartScene.classList.remove("show");
    ulduzStop();

    // No-nu disable el…ô (t…ôl…ôbd…ô No g√∂r√ºnm…ôsin)
    noBtn.disabled = true;

    // broken hearts rain start
    startBrokenRain();
  }
})();
</script>
{% endblock %}
