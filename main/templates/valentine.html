{% extends "base.html" %}

{% block title %}Valentine{% endblock %}

{% block extra_head %}
<style>
  html, body { height: 100%; overflow: hidden !important; }

  :root{
    --bg: #ffffff;
    --black: #000000;
    --shadow: 0 18px 60px rgba(0,0,0,.18);
    --shadow2: 0 26px 90px rgba(0,0,0,.26);
  }

  /* FULLSCREEN overlay (base.html-ƒ± tam √∂rt√ºr) */
  .v-screen{
    position: fixed;
    inset: 0;
    width: 100vw;
    height: 100vh;
    background: var(--bg);
    z-index: 99999;
    overflow: hidden;
    touch-action: manipulation;
    -webkit-tap-highlight-color: transparent;
  }

  .v-center{
    position: absolute;
    inset: 0;
    display: grid;
    place-items: center;
  }

  .v-row{
    position: relative;
    display: flex;
    gap: clamp(12px, 3vw, 22px);
    align-items: center;
    justify-content: center;
    width: 100%;
    padding: 22px;
  }

  /* Liquid button base */
  .btn-liquid{
    position: relative;
    display: inline-grid;
    place-items: center;
    width: min(44vw, 360px);
    height: clamp(72px, 12.5vw, 110px);
    border-radius: 999px;
    border: 0;
    cursor: pointer;
    user-select: none;
    color: #fff;
    font-weight: 900;
    letter-spacing: .2px;
    box-shadow: var(--shadow);
    transform: translateZ(0) scale(var(--scale, 1));
    transition: transform .28s ease, box-shadow .28s ease, opacity 1.1s ease;
    overflow: hidden;
    isolation: isolate;
  }

  .btn-liquid:active{ transform: translateZ(0) scale(calc(var(--scale, 1) * .985)); }
  .btn-liquid:hover{ box-shadow: var(--shadow2); }

  .btn-liquid .inner{
    position: relative;
    z-index: 3;
    font-size: clamp(28px, 8vw, 58px);
    line-height: 1;
    text-shadow: 0 10px 30px rgba(0,0,0,.22);
  }

  .btn-liquid canvas{
    position: absolute;
    inset: -60px;
    z-index: 1;
    pointer-events: none;
  }

  /* Buttons color identity (gradient is drawn in canvas, but base glow helps) */
  #yesBtn{ --scale: var(--yesScale, 1); filter: saturate(1.05); }
  #noBtn { --scale: var(--noScale, 1); filter: saturate(1.05); }

  /* No absolute when teleporting */
  .no-abs{
    position: fixed !important;
    left: 50%;
    top: 50%;
    transform: translate(-50%, -50%) scale(var(--noScale, 1));
    z-index: 6;
    margin: 0;
  }

  /* Keep YES always above NO when both visible */
  #yesBtn{ z-index: 8; }

  /* Fade helpers */
  .fade-out{ opacity: 0; transform: scale(.98); pointer-events: none; }
  .fade-in{ opacity: 1; transform: scale(1); }

  /* Fullscreen overlay darkness */
  .ov{
    position: fixed;
    inset: 0;
    background: #000;
    opacity: 0;
    pointer-events: none;
    transition: opacity 1.6s ease;
    z-index: 40;
  }
  .ov.show{ opacity: 1; }

  /* Stars / broken hearts canvases */
  canvas.fx{
    position: fixed;
    inset: 0;
    width: 100vw;
    height: 100vh;
    display: block;
    pointer-events: none;
    opacity: 0;
    transition: opacity 1.0s ease;
    z-index: 45;
  }
  canvas.fx.show{ opacity: 1; }

  /* Message */
  .msg{
    position: fixed;
    inset: 0;
    display: grid;
    place-items: center;
    text-align: center;
    padding: 26px;
    opacity: 0;
    transform: translateY(10px) scale(.985);
    transition: opacity 1.1s ease, transform 1.1s ease;
    z-index: 60;
    pointer-events: none;
    color: #fff;
    font-weight: 900;
    letter-spacing: -0.02em;
    line-height: 1.15;
  }
  .msg.show{ opacity: 1; transform: translateY(0) scale(1); }

  /* Animated typography (not ‚Äústraight list‚Äù) */
  .msg .line{
    display: block;
    opacity: 0;
    transform: translateY(14px) rotate(-1deg);
    filter: blur(1px);
    animation: lineIn .9s ease forwards;
  }
  .msg .line.l2{ animation-delay: .18s; transform: translateY(16px) rotate(1deg); }
  .msg .line.l3{ animation-delay: .36s; transform: translateY(18px) rotate(-1deg); }

  .msg .line strong{
    background: linear-gradient(90deg, #7c3aed, #22c55e, #ff2d55);
    -webkit-background-clip: text;
    background-clip: text;
    color: transparent;
  }

  @keyframes lineIn{
    to{ opacity: 1; transform: translateY(0) rotate(0deg); filter: blur(0); }
  }

  .msg .t1{ font-size: clamp(20px, 5.4vw, 44px); }
  .msg .t2{ font-size: clamp(16px, 4.2vw, 34px); }
  .msg .t3{ font-size: clamp(14px, 3.8vw, 30px); opacity: .95; }

  /* Heart scene */
  .heartScene{
    position: fixed;
    inset: 0;
    background: #000;
    opacity: 0;
    transition: opacity 1.1s ease;
    z-index: 80;
    pointer-events: none;
  }
  .heartScene.show{ opacity: 1; }

  #heartCanvas{
    width: 100vw;
    height: 100vh;
    display: block;
  }

  /* Stage 9: black + only huge YES */
  .stage9{
    background: #000 !important;
  }
  .stage9 #noBtn{ display: none !important; }
  .stage9 #yesBtn{
    position: fixed !important;
    left: 50% !important;
    top: 50% !important;
    transform: translate(-50%, -50%) scale(var(--yesScale, 1)) !important;
    width: min(86vw, 820px) !important;
    height: clamp(88px, 15vw, 140px) !important;
    z-index: 120 !important;
    box-shadow: 0 30px 120px rgba(0,0,0,.75);
  }

  /* NO click animations */
  .shake3s{ animation: shake .12s ease-in-out infinite; }
  @keyframes shake{
    0%  { transform: translate(-50%,-50%) scale(var(--noScale, 1)) translateX(-2px); }
    50% { transform: translate(-50%,-50%) scale(var(--noScale, 1)) translateX( 2px); }
    100%{ transform: translate(-50%,-50%) scale(var(--noScale, 1)) translateX(-2px); }
  }

  .break5s{ animation: splitJoin 5s ease-in-out forwards; }
  @keyframes splitJoin{
    0%   { clip-path: inset(0 0 0 0); }
    18%  { clip-path: inset(0 50% 0 0); transform: translate(-50%,-50%) scale(var(--noScale, 1)) translateX(-16px) rotate(-2deg); }
    36%  { clip-path: inset(0 0 0 50%); transform: translate(-50%,-50%) scale(var(--noScale, 1)) translateX( 16px) rotate( 2deg); }
    62%  { clip-path: inset(0 0 0 0); transform: translate(-50%,-50%) scale(var(--noScale, 1)) translateX(0) rotate(0deg); }
    100% { clip-path: inset(0 0 0 0); transform: translate(-50%,-50%) scale(var(--noScale, 1)); }
  }

  @media (max-width: 420px){
    .btn-liquid{ width: min(45vw, 240px); }
  }
</style>
{% endblock %}

{% block content %}
<div class="v-screen" id="root">
  <div class="v-center">
    <div class="v-row" id="row">
      <button class="btn-liquid" id="yesBtn" type="button">
        <span class="inner">Tak</span>
      </button>

      <button class="btn-liquid" id="noBtn" type="button">
        <span class="inner">Nie</span>
      </button>
    </div>
  </div>

  <div class="ov" id="dark"></div>

  <canvas class="fx" id="stars"></canvas>
  <canvas class="fx" id="broken"></canvas>

  <div class="msg" id="msg"></div>

  <div class="heartScene" id="heartScene">
    <canvas id="heartCanvas"></canvas>
  </div>
</div>

<script>
/*
  Kod: Az…ôrbaycan dilind…ô.
  UI m…ôtnl…ôri: yalnƒ±z Tak / Nie / final mesaj (polyakca).
*/

(function(){
  const root = document.getElementById("root");
  const row  = document.getElementById("row");
  const yesBtn = document.getElementById("yesBtn");
  const noBtn  = document.getElementById("noBtn");

  const dark = document.getElementById("dark");
  const stars = document.getElementById("stars");
  const broken = document.getElementById("broken");
  const msg = document.getElementById("msg");

  const heartScene = document.getElementById("heartScene");
  const heartCanvas = document.getElementById("heartCanvas");

  const sctx = stars.getContext("2d");
  const bctx = broken.getContext("2d");
  const hctx = heartCanvas.getContext("2d");

  // Polyakca final mesaj (maraqlƒ±, m…ôrk…ôzd…ô, animasiyalƒ±)
  const MESAJ_HTML = `
    <span class="line t1"><strong>Gratulacje!</strong></span>
    <span class="line l2 t2">Od teraz jeste≈õcie walentynkami‚Ä¶</span>
    <span class="line l3 t3"><strong>Elvin</strong> & <strong>Ola</strong> üíú</span>
  `;

  let noKlik = 0;
  let yesScale = 1;
  let noScale = 1;

  let yesFlowAktiv = false;
  let stage9Aktiv = false;

  // ====== √ñl√ß√º / DPR ======
  function canvasOlcu(){
    const dpr = Math.max(1, window.devicePixelRatio || 1);
    const w = window.innerWidth;
    const h = window.innerHeight;

    [stars, broken].forEach(c => {
      c.width = Math.floor(w * dpr);
      c.height = Math.floor(h * dpr);
      c.style.width = w + "px";
      c.style.height = h + "px";
    });
    sctx.setTransform(dpr,0,0,dpr,0,0);
    bctx.setTransform(dpr,0,0,dpr,0,0);

    heartCanvas.width = Math.floor(w * dpr);
    heartCanvas.height = Math.floor(h * dpr);
    heartCanvas.style.width = w + "px";
    heartCanvas.style.height = h + "px";
    hctx.setTransform(dpr,0,0,dpr,0,0);
  }
  window.addEventListener("resize", canvasOlcu, { passive:true });
  canvasOlcu();

  // ====== CSS scale ======
  function skalaQur(){
    root.style.setProperty("--yesScale", String(yesScale));
    root.style.setProperty("--noScale", String(noScale));
  }
  skalaQur();

  // ====== Liquid Buttons (mouse olmasa da oynasƒ±n) ======
  class LiquidButton{
    constructor(el, cfg){
      this.el = el;
      this.cfg = cfg;

      this.canvas = document.createElement("canvas");
      this.el.appendChild(this.canvas);
      this.ctx = this.canvas.getContext("2d");

      this.pointsA = [];
      this.pointsB = [];

      this.fakeT = Math.random() * 1000; // ‚Äúfake mouse‚Äù vaxtƒ±
      this.relMouseX = 0;
      this.relMouseY = 0;

      this.init();
      this.render();
    }

    init(){
      const rect = this.el.getBoundingClientRect();
      const w = rect.width;
      const h = rect.height;

      // canvas margin (liquid spill)
      this.canvas.width = Math.ceil(w + 120);
      this.canvas.height = Math.ceil(h + 120);
      this.canvas.style.width = (w + 120) + "px";
      this.canvas.style.height = (h + 120) + "px";

      this.off = 60;

      this.pointsA.length = 0;
      this.pointsB.length = 0;

      const points = this.cfg.points;
      const buttonW = w;
      const buttonH = h;

      const x0 = buttonH/2;
      const addPoint = (x,y) => {
        this.pointsA.push(new Point(this.off + x, this.off + y, 1));
        this.pointsB.push(new Point(this.off + x, this.off + y, 2));
      };

      for(let j=1;j<points;j++){
        addPoint((x0 + ((buttonW-buttonH)/points)*j), 0);
      }
      addPoint(buttonW-buttonH/5, 0);
      addPoint(buttonW+buttonH/10, buttonH/2);
      addPoint(buttonW-buttonH/5, buttonH);
      for(let j=points-1;j>0;j--){
        addPoint((x0 + ((buttonW-buttonH)/points)*j), buttonH);
      }
      addPoint(buttonH/5, buttonH);
      addPoint(-buttonH/10, buttonH/2);
      addPoint(buttonH/5, 0);

      // start in center
      this.relMouseX = this.off + buttonW/2;
      this.relMouseY = this.off + buttonH/2;
    }

    updateFakeMouse(){
      // Mouse olmadan da ‚Äúliquid‚Äù canlƒ± qalsƒ±n dey…ô sinus trayektoriya
      this.fakeT += 0.018;

      const rect = this.el.getBoundingClientRect();
      const w = rect.width, h = rect.height;

      const ax = (Math.sin(this.fakeT) * 0.35 + Math.sin(this.fakeT*0.7)*0.15);
      const ay = (Math.cos(this.fakeT*1.1) * 0.32 + Math.sin(this.fakeT*0.9)*0.12);

      this.relMouseX = this.off + (w/2) + ax * (w*0.45);
      this.relMouseY = this.off + (h/2) + ay * (h*0.40);

      // very small drift, keeps it ‚Äúalive‚Äù
      this.mouseSpeedX = Math.sin(this.fakeT*2.0) * 1.4;
      this.mouseSpeedY = Math.cos(this.fakeT*1.7) * 1.2;

      // direction
      this.mouseDirectionX = this.mouseSpeedX > 0 ? 1 : -1;
      this.mouseDirectionY = this.mouseSpeedY > 0 ? 1 : -1;
    }

    render(){
      requestAnimationFrame(()=>this.render());

      // base changes on resize
      if(this._resizeTick === undefined) this._resizeTick = 0;
      this._resizeTick++;
      if(this._resizeTick % 25 === 0){
        const rect = this.el.getBoundingClientRect();
        const desiredW = Math.ceil(rect.width + 120);
        const desiredH = Math.ceil(rect.height + 120);
        if(this.canvas.width !== desiredW || this.canvas.height !== desiredH){
          this.init();
        }
      }

      this.updateFakeMouse();

      const ctx = this.ctx;
      const cw = this.canvas.width;
      const ch = this.canvas.height;

      ctx.clearRect(0,0,cw,ch);

      // move points
      for(let i=0;i<this.pointsA.length;i++){
        this.pointsA[i].move(this);
        this.pointsB[i].move(this);
      }

      // background layer
      ctx.beginPath();
      drawBlob(ctx, this.pointsA);
      ctx.closePath();
      ctx.fillStyle = this.cfg.back;
      ctx.fill();

      // gradient layer
      const gx = this.relMouseX;
      const gy = this.relMouseY;
      const grad = ctx.createRadialGradient(gx, gy, 320, gx, gy, 0);
      grad.addColorStop(0, this.cfg.gradA);
      grad.addColorStop(1, this.cfg.gradB);

      ctx.beginPath();
      drawBlob(ctx, this.pointsB);
      ctx.closePath();
      ctx.fillStyle = grad;
      ctx.fill();
    }
  }

  function Point(x,y,level){
    this.x = this.ix = x;
    this.y = this.iy = y;
    this.vx = 0;
    this.vy = 0;
    this.level = level;
  }

  Point.prototype.move = function(host){
    const viscosity = host.cfg.viscosity;
    const damping = host.cfg.damping;
    const mouseDist = host.cfg.mouseDist;

    // spring to origin
    this.vx += (this.ix - this.x) / (viscosity * this.level);
    this.vy += (this.iy - this.y) / (viscosity * this.level);

    // fake mouse influence
    const dx = this.ix - host.relMouseX;
    const dy = this.iy - host.relMouseY;
    const relDist = (1 - Math.sqrt((dx*dx) + (dy*dy)) / mouseDist);

    if(relDist > 0 && relDist < 1){
      this.vx += (host.mouseSpeedX / 4) * relDist;
      this.vy += (host.mouseSpeedY / 4) * relDist;
    }

    this.vx *= (1 - damping);
    this.vy *= (1 - damping);
    this.x += this.vx;
    this.y += this.vy;
  };

  function drawBlob(ctx, pts){
    ctx.moveTo(pts[0].x, pts[0].y);
    for(let i=0;i<pts.length;i++){
      const p = pts[i];
      const np = pts[i+1] || pts[0];
      const cx = (p.x + np.x) / 2;
      const cy = (p.y + np.y) / 2;
      ctx.quadraticCurveTo(p.x, p.y, cx, cy);
    }
  }

  // Liquid button instances
  const yesLiquid = new LiquidButton(yesBtn, {
    points: 8,
    viscosity: 18,
    mouseDist: 75,
    damping: 0.06,
    back:  "#1CE2D8",
    gradA: "#22c55e",
    gradB: "#7c3aed"
  });

  const noLiquid = new LiquidButton(noBtn, {
    points: 8,
    viscosity: 18,
    mouseDist: 75,
    damping: 0.06,
    back:  "#ff9aa2",
    gradA: "#ff2d55",
    gradB: "#ef4444"
  });

  // ====== NIE teleport / Tak √ºst…ô d√º≈üm…ôsin ======
  function noAbsoluteEt(){
    if(!noBtn.classList.contains("no-abs")){
      noBtn.classList.add("no-abs");
      root.appendChild(noBtn);
    }
  }

  function noAnimTemizle(){
    noBtn.classList.remove("shake3s");
    noBtn.classList.remove("break5s");
  }

  function qadaƒüaZonaVar(x, y){
    // Tak d√ºym…ôsinin real yerin…ô g√∂r…ô qadaƒüan zona
    const r = yesBtn.getBoundingClientRect();
    const cx = r.left + r.width/2;
    const cy = r.top  + r.height/2;

    const dx = Math.abs(x - cx);
    const dy = Math.abs(y - cy);

    // Tak …ôtrafƒ±nda ‚Äúqadaƒüan‚Äù radius (telefon √º√ß√ºn bir az b√∂y√ºk)
    return (dx < (r.width*0.85) && dy < (r.height*0.75));
  }

  function noYerQur(px, py){
    noAbsoluteEt();
    noBtn.style.left = px + "px";
    noBtn.style.top  = py + "px";
  }

  function randomNoYer(){
    const pad = 24;
    const r = noBtn.getBoundingClientRect();
    const bw = r.width || 260;
    const bh = r.height || 90;

    const maxX = window.innerWidth - bw - pad;
    const maxY = window.innerHeight - bh - pad;

    let x, y, guard = 0;
    do{
      x = pad + Math.random() * Math.max(1, maxX - pad);
      y = pad + Math.random() * Math.max(1, maxY - pad);
      guard++;
      if(guard > 60) break;
    } while(qadaƒüaZonaVar(x + bw/2, y + bh/2));

    noYerQur(x, y);
  }

  // ====== Stars rain ======
  let starsArr = [];
  let starsRAF = null;

  function starsHazirla(){
    starsArr = [];
    const w = window.innerWidth, h = window.innerHeight;
    const say = Math.max(80, Math.floor((w*h)/22000));
    for(let i=0;i<say;i++){
      starsArr.push({
        x: Math.random()*w,
        y: Math.random()*h,
        sp: 2 + Math.random()*5,
        sz: 1 + Math.random()*2.4,
        a: 0.45 + Math.random()*0.55
      });
    }
  }

  function starsCek(){
    const w = window.innerWidth, h = window.innerHeight;
    sctx.clearRect(0,0,w,h);

    for(const p of starsArr){
      p.y += p.sp;
      if(p.y > h + 10){ p.y = -10; p.x = Math.random()*w; }
      sctx.globalAlpha = p.a;
      sctx.fillStyle = "#fff";
      sctx.beginPath();
      sctx.arc(p.x, p.y, p.sz, 0, Math.PI*2);
      sctx.fill();
    }
    starsRAF = requestAnimationFrame(starsCek);
  }

  function starsStart(){
    stars.classList.add("show");
    starsHazirla();
    if(starsRAF) cancelAnimationFrame(starsRAF);
    starsRAF = requestAnimationFrame(starsCek);
  }

  function starsStop(){
    stars.classList.remove("show");
    if(starsRAF) cancelAnimationFrame(starsRAF);
    starsRAF = null;
    sctx.clearRect(0,0,window.innerWidth, window.innerHeight);
  }

  // ====== Broken hearts rain (stage9) ======
  let brokenArr = [];
  let brokenRAF = null;

  function brokenHazirla(){
    brokenArr = [];
    const w = window.innerWidth, h = window.innerHeight;
    const say = Math.max(90, Math.floor((w*h)/16000));
    for(let i=0;i<say;i++){
      brokenArr.push({
        x: Math.random()*w,
        y: Math.random()*h,
        sp: 3 + Math.random()*6.8,
        sz: 18 + Math.random()*20,
        rot: Math.random()*Math.PI*2,
        vr: (-0.03 + Math.random()*0.06),
        a: 0.65 + Math.random()*0.35,
      });
    }
  }

  function brokenCek(){
    const w = window.innerWidth, h = window.innerHeight;
    bctx.clearRect(0,0,w,h);

    for(const p of brokenArr){
      p.y += p.sp;
      p.rot += p.vr;
      if(p.y > h + 40){ p.y = -40; p.x = Math.random()*w; }
      bctx.save();
      bctx.translate(p.x, p.y);
      bctx.rotate(p.rot);
      bctx.globalAlpha = p.a;
      bctx.font = `${p.sz}px system-ui, Apple Color Emoji, Segoe UI Emoji, Noto Color Emoji`;
      bctx.textAlign = "center";
      bctx.textBaseline = "middle";
      bctx.fillText("üíî", 0, 0);
      bctx.restore();
    }
    brokenRAF = requestAnimationFrame(brokenCek);
  }

  function brokenStart(){
    broken.classList.add("show");
    brokenHazirla();
    if(brokenRAF) cancelAnimationFrame(brokenRAF);
    brokenRAF = requestAnimationFrame(brokenCek);
  }

  function brokenStop(){
    broken.classList.remove("show");
    if(brokenRAF) cancelAnimationFrame(brokenRAF);
    brokenRAF = null;
    bctx.clearRect(0,0,window.innerWidth, window.innerHeight);
  }

  // ====== Liquid Heart (tam simmetrik, dalƒüalƒ±) ======
  let heartRAF = null;
  let heartT = 0;

  function heartStart(){
    heartScene.classList.add("show");
    heartT = 0;
    if(heartRAF) cancelAnimationFrame(heartRAF);
    heartRAF = requestAnimationFrame(heartDraw);
  }

  function heartStop(){
    heartScene.classList.remove("show");
    if(heartRAF) cancelAnimationFrame(heartRAF);
    heartRAF = null;
    hctx.clearRect(0,0,window.innerWidth, window.innerHeight);
  }

  function heartDraw(){
    const w = window.innerWidth, h = window.innerHeight;
    hctx.clearRect(0,0,w,h);

    // soft vignette
    const vg = hctx.createRadialGradient(w/2, h/2, 40, w/2, h/2, Math.max(w,h)*0.7);
    vg.addColorStop(0, "rgba(255,45,85,0.10)");
    vg.addColorStop(1, "rgba(0,0,0,0)");
    hctx.fillStyle = vg;
    hctx.fillRect(0,0,w,h);

    heartT += 0.018;

    const cx = w/2;
    const cy = h/2;

    // ‚Äúbeat‚Äù + wave
    const beat = 1 + Math.sin(heartT*2.2) * 0.06;
    const baseSize = Math.min(w, h) * 0.18;

    // Heart parametric points (symmetric by formula)
    const pts = [];
    const N = 220;

    for(let i=0;i<=N;i++){
      const t = (i / N) * Math.PI * 2;
      // classic heart curve
      const x = 16 * Math.pow(Math.sin(t), 3);
      const y = 13 * Math.cos(t) - 5 * Math.cos(2*t) - 2 * Math.cos(3*t) - Math.cos(4*t);

      // wave perturbation (still symmetric because depends on t, not x sign)
      const wave = 1 + Math.sin(t*6 + heartT*3.0) * 0.045 + Math.cos(t*3 - heartT*2.0) * 0.03;

      const px = cx + (x * baseSize * 0.065) * beat * wave;
      const py = cy - (y * baseSize * 0.065) * beat * wave; // invert y

      pts.push({x:px, y:py});
    }

    // gradient fill
    const g = hctx.createRadialGradient(cx - baseSize*0.2, cy - baseSize*0.2, baseSize*0.2, cx, cy, baseSize*1.4);
    g.addColorStop(0, "rgba(255,110,150,1)");
    g.addColorStop(0.55, "rgba(255,45,85,1)");
    g.addColorStop(1, "rgba(160,10,60,1)");

    // draw smooth curve
    hctx.beginPath();
    hctx.moveTo(pts[0].x, pts[0].y);
    for(let i=1;i<pts.length-2;i++){
      const cpx = (pts[i].x + pts[i+1].x) / 2;
      const cpy = (pts[i].y + pts[i+1].y) / 2;
      hctx.quadraticCurveTo(pts[i].x, pts[i].y, cpx, cpy);
    }
    hctx.closePath();

    hctx.fillStyle = g;
    hctx.fill();

    // subtle outline
    hctx.globalAlpha = 0.22;
    hctx.lineWidth = Math.max(1.5, baseSize*0.02);
    hctx.strokeStyle = "rgba(255,255,255,0.65)";
    hctx.stroke();
    hctx.globalAlpha = 1;

    // glow
    hctx.save();
    hctx.globalCompositeOperation = "lighter";
    hctx.globalAlpha = 0.10;
    hctx.shadowColor = "rgba(255,45,85,0.85)";
    hctx.shadowBlur = baseSize * 0.55;
    hctx.fillStyle = "rgba(255,45,85,0.55)";
    hctx.fill();
    hctx.restore();

    heartRAF = requestAnimationFrame(heartDraw);
  }

  // ====== Reset ======
  function resetBaslangic(){
    yesFlowAktiv = false;
    stage9Aktiv = false;

    root.classList.remove("stage9");
    dark.classList.remove("show");

    starsStop();
    brokenStop();
    heartStop();

    msg.classList.remove("show");
    msg.innerHTML = "";

    row.classList.remove("fade-out");
    yesBtn.disabled = false;
    noBtn.disabled = false;

    noKlik = 0;
    yesScale = 1;
    noScale = 1;
    skalaQur();

    // No d√ºym…ôsini geri qaytar
    if(noBtn.classList.contains("no-abs")){
      noAnimTemizle();
      noBtn.classList.remove("no-abs");
      noBtn.style.left = "";
      noBtn.style.top = "";
      row.appendChild(noBtn);
    }
  }

  // ====== Stage 9 ======
  function stage9Basla(){
    stage9Aktiv = true;

    // everything off
    starsStop();
    heartStop();
    msg.classList.remove("show");
    msg.innerHTML = "";
    dark.classList.remove("show");

    root.classList.add("stage9");
    noBtn.disabled = true; // anyway it‚Äôs hidden
    brokenStart();
  }

  // ====== YES flow ======
  function yesFlowBasla(){
    if(yesFlowAktiv) return;
    yesFlowAktiv = true;

    // stage9 varsa dayandƒ±r
    if(stage9Aktiv){
      brokenStop();
      stage9Aktiv = false;
      root.classList.remove("stage9");
    }

    // buttons fade out
    row.classList.add("fade-out");
    yesBtn.disabled = true;
    noBtn.disabled = true;

    // full dark
    dark.classList.add("show");

    // stars + message
    starsStart();
    msg.innerHTML = MESAJ_HTML;
    msg.classList.add("show");

    // 5s sonra: message off, heart on (10s)
    setTimeout(() => {
      msg.classList.remove("show");
      msg.innerHTML = "";
      starsStop();
      heartStart();
    }, 5000);

    // 15s sonra reset
    setTimeout(() => {
      resetBaslangic();
    }, 15000);
  }

  // ===== Clicks =====
  yesBtn.addEventListener("click", () => {
    if(stage9Aktiv){
      // Stage 9-da Tak basƒ±lƒ±nca: yaƒüƒ±≈ü dayanƒ±r v…ô Yes flow ba≈ülayƒ±r
      brokenStop();
      stage9Aktiv = false;
      root.classList.remove("stage9");
    }
    yesFlowBasla();
  });

  noBtn.addEventListener("click", () => {
    if(yesFlowAktiv) return;

    noKlik += 1;

    // h…ôr klikd…ô yer d…ôyi≈üsin (t…ôl…ôbin √ºmumi hiss…ôsi)
    if(![3,4,6,9].includes(noKlik)){
      randomNoYer();
    }else{
      noAbsoluteEt();
    }

    // 1: 3s shake
    if(noKlik === 1){
      noAnimTemizle();
      noBtn.classList.add("shake3s");
      setTimeout(()=> noBtn.classList.remove("shake3s"), 3000);
      return;
    }

    // 2: split+join 5s
    if(noKlik === 2){
      noAnimTemizle();
      noBtn.classList.add("break5s");
      setTimeout(()=> noBtn.classList.remove("break5s"), 5000);
      return;
    }

    // 3: sol √ºst
    if(noKlik === 3){
      noYerQur(26, 26);
      return;
    }

    // 4: saƒü alt
    if(noKlik === 4){
      const r = noBtn.getBoundingClientRect();
      noYerQur(window.innerWidth - r.width - 26, window.innerHeight - r.height - 26);
      return;
    }

    // 6: orta yuxarƒ±
    if(noKlik === 6){
      const r = noBtn.getBoundingClientRect();
      noYerQur((window.innerWidth - r.width)/2, 22);
      return;
    }

    // 7: No 2x ki√ßik, Yes 2x b√∂y√ºk
    if(noKlik === 7){
      noScale *= 0.5;
      yesScale *= 2;
      skalaQur();
      randomNoYer();
      return;
    }

    // 8: yen…ô
    if(noKlik === 8){
      noScale *= 0.5;
      yesScale *= 2;
      skalaQur();
      randomNoYer();
      return;
    }

    // 9: qara ekran + yalnƒ±z Tak + üíî yaƒüƒ±≈üƒ± (Tak basƒ±lana q…ôd…ôr)
    if(noKlik === 9){
      stage9Basla();
      return;
    }
  });

})();
</script>
{% endblock %}
